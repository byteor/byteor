# Linux Networking Virtualization

## network namespace

1. namespace isolation

- Mount
- UTS
- IPC
- PID
- Network (ip address, port, route table, firewall, ...)
- User

2. tools

- ip netns help
- nsenter/unshare
- nc/ping
- `/proc/<pid>/ns`

## veth pair

~~~
+----------------------------------------------------------------------------+
|                                                                            |
|                         kernel network protocol stack                      |
|                                                                            |
+----------------------------------------------------------------------------+
|           ^                    ^                      ^                    |
|           |                    |                      |                    |
|           v                    v                      v                    |
|        +------+            +-------+              +-------+                |
|        | eth0 |1.2.3.4     | veth0 |              | veth1 |                |
|        +------+            +-------+              +-------+                |
|           |                    ^                      ^                    |
|           |                    |                      |                    |
|           |                    +----------------------+                    |
|           |              10.20.30.40/24         10.20.30.41/24             |
|           |                                                                |
+-----------|----------------------------------------------------------------+
|           |                                                                |
|           v                                                                |
|        +----------+                                                        |
|        | physical |                                                        |
|        | network  |                                                        |
|        | card     |                                                        |
|        +----------+                                                        |
+----------------------------------------------------------------------------+
~~~

## linux bridge

~~~
+----------------------------------------------------------------------------+
|                                                                            |
|                          kernel network protocol stack                     |
|                                                                            |
+----------------------------------------------------------------------------+
|                              ^                                   ^         |
|                              |                                   |         |
|                              v                                   v         |
|          +------+         +-----+     +-------+              +-------+     |
|          | eth0 |         | br0 |<--->| veth0 |              | veth1 |     |
|          +------+         +-----+     +-------+              +-------+     |
|             ^            1.2.3.101        ^                      ^         |
|             |                             |                      |         |
|             |                             +----------------------+         |
|             |                                                1.2.3.102     |
|             |                                                              |
+-------------|--------------------------------------------------------------+
|             |                                                              |
|             v                                                              |
|                                                                            |
+----------------------------------------------------------------------------+
~~~

## tun/tap

~~~
+----------------------------------------------------------------------------+
|User Space      +------+                           +------+                 |
|                | app1 |                           | app2 |<----------+     |
|                +------+                           +------+           |     |
|                    | (1)                              | (5)          |     |
|                    v                                  v              |     |
|             +------------+                      +------------+       |     |
|             | socket api |                      | socket api |       |     |
|             +------------+                      +------------+       |     |
|                    | (2)                              | (6)          |     |
|--------------------|----------------------------------|-------/dev/tun0----|
|Kernel Space        v                                  v              |     |
|        +----------------------------------------------------------+  |     |
|        |           kernel network protocol stack                  |  |     |
|        +----------------------------------------------------------+  |     |
|                    | (7)                              | (3)          |     |
|                    v                                  v              |     |
|                 +------+                           +------+          |     |
|                 | eth0 |                           | tun0 |          |     |
|                 +------+                           +------+          |     |
|      100.89.104.21 | (8)                              |        (4)   |     |
|                    v                                  +--------------+     |
|              Physical Network                            192.168.1.2       |
+----------------------------------------------------------------------------+
~~~

## iptables/netfilter

~~~
+---------------------------------------------------------------------------------+
|    +---------------+                               +---------------+            |
|    | device driver |     OUT OF PROTOCOL STACK     | device driver |            |
|    +---------------+                               +---------------+            |
|           | datagram                                       ^ datagram           |
+-----------|------------------------------------------------|--------------------+
|           v                  PROTOCOL STACK                |                    |
|     +------------+                                  +-------------+(MANGLE      |
|     | PREROUTING | (RAW,MANGLE,DNAT)                | POSTROUTING | SNAT)       |
|     +------------+                                  +-------------+             |
|           |                                                ^                    |
|           v                                                |                    |
|       +-------+                                            |                    |
|       | ROUTE |                                            |                    |
|       +-------+        (MANGLE,FILTER,SECURITY)            |                    |
|           |                 +---------+                    |                    |
|           +---------------->| FORWARD |------------------->|                    |
|           |                 +---------+                    |                    |
|           |                                            +-------+                |
|           |                                            | ROUTE |                |
|           |                                            +-------+                |
|           |                                                ^                    |
|           v                                                |     (RAW           |
|       +-------+                                        +--------+ MANGLE        |
|       | INPUT | (MANGLE,SNAT,FILTER)                   | OUTPUT | DNAT          |
|       +-------+                                        +--------+ FILTER        |
|           |                                                ^      SECURITY)     |
+-----------|------------------------------------------------|--------------------+
|           |                                                |                    |
|           |                 +---------------+              |                    |
|           +---------------->| local process |--------------+                    |
|                             +---------------+                                   |
+---------------------------------------------------------------------------------+
~~~
